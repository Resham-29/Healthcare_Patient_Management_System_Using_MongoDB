<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Patient Management</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for base and overrides */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        /* Hide the default message div initially, Tailwind handles display changes */
        .message {
            display: none;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            margin-bottom: 1rem;
            opacity: 0; /* Start hidden for animation */
            transition: opacity 0.3s ease-in-out;
        }
        .message.show {
            opacity: 1; /* Show for animation */
        }
        .success {
            background-color: #d4edda; /* Light green */
            color: #155724; /* Dark green text */
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da; /* Light red */
            color: #721c24; /* Dark red text */
            border: 1px solid #f5c6cb;
        }
        /* Style for Scroll to Top Button */
        #scrollToTopBtn {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position */
            bottom: 20px; /* Place at the bottom */
            right: 20px; /* Place at the right */
            z-index: 99; /* High z-index to be on top */
            border: none; /* Remove borders */
            outline: none; /* Remove outline */
            background-color: #4CAF50; /* Green background */
            color: white; /* White text */
            cursor: pointer; /* Add a mouse pointer on hover */
            padding: 15px; /* Some padding */
            border-radius: 50%; /* Rounded corners */
            font-size: 18px; /* Increase font size */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Subtle shadow */
            transition: background-color 0.3s, transform 0.3s; /* Smooth transition */
        }
        #scrollToTopBtn:hover {
            background-color: #45a049; /* Darker green on hover */
            transform: scale(1.1); /* Slightly enlarge on hover */
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Page Load Animation */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-fadeInScale {
            animation: fadeInScale 0.5s ease-out forwards;
        }

        /* Patient Card Entry Animation */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .patient-card.animate-slideInUp {
            animation: slideInUp 0.4s ease-out forwards;
        }

        /* Input focus effect */
        input:focus, select:focus, textarea:focus {
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); /* blue-400 with 50% opacity */
            border-color: #63b3ed; /* blue-300 */
        }

        /* Button click effect */
        button:active {
            transform: scale(0.98);
        }

        /* Hidden initially, shown after login */
        #appContainer {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-between">

    <!-- Sticky Top Navigation Bar -->
    <nav id="topNavBar" class="fixed top-0 left-0 w-full bg-blue-900 text-white shadow-lg py-4 px-6 z-50 hidden">
        <div class="container mx-auto flex justify-between items-center max-w-7xl">
            <div class="text-2xl font-bold text-blue-100">Healthcare PMS</div>
            <ul class="flex space-x-6">
                <li><a href="#" class="hover:text-blue-300 transition duration-200">Dashboard</a></li>
                <li><a href="#" class="hover:text-blue-300 transition duration-200">Patients</a></li>
                <li><a href="#" class="hover:text-blue-300 transition duration-200">Reports</a></li>
                <li><a href="#" class="hover:text-blue-300 transition duration-200">Settings</a></li>
            </ul>
            <button id="logoutBtnNav" class="py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200 shadow-sm flex items-center space-x-2">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </button>
        </div>
    </nav>


    <!-- Login/Registration Container -->
    <div id="authContainer" class="container bg-white shadow-xl rounded-xl p-8 max-w-sm w-full my-auto animate-fadeInScale">
        <h1 class="text-3xl font-bold text-center text-blue-800 mb-6" id="authTitle">Login</h1>

        <div id="authMessage" class="message"></div>

        <form id="authForm" class="space-y-4">
            <div>
                <label for="authUsername" class="block text-gray-700 font-medium mb-1">Username:</label>
                <input type="text" id="authUsername" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
            </div>
            <div>
                <label for="authPassword" class="block text-gray-700 font-medium mb-1">Password:</label>
                <input type="password" id="authPassword" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
            </div>
            <div id="roleSelectDiv" class="hidden">
                <label for="authRole" class="block text-gray-700 font-medium mb-1">Role:</label>
                <select id="authRole" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                    <option value="receptionist">Receptionist</option>
                    <option value="nurse">Nurse</option>
                    <option value="doctor">Doctor</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <button type="submit" id="authSubmitBtn" class="w-full py-3 px-6 bg-gradient-to-r from-blue-500 to-blue-700 text-white font-semibold rounded-lg shadow-md hover:from-blue-600 hover:to-blue-800 transition duration-300 ease-in-out transform hover:scale-105">
                Login
            </button>
        </form>
        <div class="text-center mt-4">
            <button id="toggleAuthMode" class="text-blue-600 hover:underline text-sm">Don't have an account? Register</button>
        </div>
    </div>

    <!-- Main Application Container (Hidden initially) -->
    <div id="appContainer" class="container bg-white shadow-xl rounded-xl p-8 max-w-3xl w-full mt-20 mb-8">
        <div class="flex justify-between items-center mb-6">
            <div class="text-center flex-grow">
                <img src="https://placehold.co/150x150/e0e7ff/3f51b5?text=Medical+Icon" alt="Medical Icon" class="mx-auto mb-4 rounded-full shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/150x150/e0e7ff/3f51b5?text=Img+Error';">
                <h1 class="text-4xl font-bold text-center text-blue-800 mb-2">Healthcare Patient Management</h1>
                <p class="text-gray-600 text-lg">Efficiently manage patient data and medical records.</p>
            </div>
        </div>

        <!-- Message Display Area -->
        <div id="message" class="message"></div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Left Column: Add/Update Patient Section & Analytics Dashboard -->
            <div class="flex flex-col gap-8">
                <!-- Add/Update Patient Section -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <h2 id="formTitle" class="text-2xl font-semibold text-blue-700 mb-4 flex items-center space-x-2">
                        <i class="fas fa-user-plus text-blue-600"></i>
                        <span>Add New Patient</span>
                    </h2>
                    <form id="patientForm" class="space-y-4">
                        <input type="hidden" id="editingPatientId"> <!-- Hidden field for patient ID when editing -->
                        <div>
                            <label for="patientId" class="block text-gray-700 font-medium mb-1">Patient ID:</label>
                            <input type="text" id="patientId" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                        </div>
                        <div>
                            <label for="name" class="block text-gray-700 font-medium mb-1">Name:</label>
                            <input type="text" id="name" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                        </div>
                        <div>
                            <label for="age" class="block text-gray-700 font-medium mb-1">Age:</label>
                            <input type="number" id="age" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                        </div>
                        <div>
                            <label for="gender" class="block text-gray-700 font-medium mb-1 flex items-center space-x-2">
                                <i class="fas fa-venus-mars text-blue-500"></i> <span>Gender:</span>
                            </label>
                            <select id="gender" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="bloodGroup" class="block text-gray-700 font-medium mb-1 flex items-center space-x-2">
                                <i class="fas fa-tint text-red-600"></i> <span>Blood Group:</span>
                            </label>
                            <select id="bloodGroup" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                                <option value="">Select Blood Group (Optional)</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div>
                            <label for="department" class="block text-gray-700 font-medium mb-1 flex items-center space-x-2">
                                <i class="fas fa-hospital text-blue-500"></i> <span>Department:</span>
                            </label>
                            <input type="text" id="department" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200" placeholder="e.g., Cardiology, Pediatrics">
                        </div>
                        <div>
                            <label for="contactInfo" class="block text-gray-700 font-medium mb-1">Contact Info:</label>
                            <input type="text" id="contactInfo" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                        </div>
                        <div>
                            <label for="allergies" class="block text-gray-700 font-medium mb-1 flex items-center space-x-2">
                                <i class="fas fa-allergies text-yellow-500"></i> <span>Allergies (comma separated):</span>
                            </label>
                            <input type="text" id="allergies" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200" placeholder="e.g., Penicillin, Peanuts">
                        </div>

                        <!-- Medical History Section -->
                        <div class="border p-4 rounded-md bg-white">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                                    <i class="fas fa-history text-gray-600"></i> <span>Medical History</span>
                                </h3>
                                <button type="button" onclick="addMedicalHistoryField()" class="bg-blue-200 text-blue-800 p-2 rounded-full hover:bg-blue-300 transition duration-200">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="medicalHistoryFields" class="space-y-3">
                                <!-- Dynamic medical history fields will be added here -->
                                <p class="text-gray-500 text-sm italic" id="noMedicalHistoryMsg">No medical history entries. Click '+' to add.</p>
                            </div>
                        </div>

                        <!-- Current Prescriptions Section -->
                        <div class="border p-4 rounded-md bg-white">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                                    <i class="fas fa-prescription-bottle-alt text-green-600"></i> <span>Current Prescriptions</span>
                                </h3>
                                <button type="button" onclick="addPrescriptionField()" class="bg-blue-200 text-blue-800 p-2 rounded-full hover:bg-blue-300 transition duration-200">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="prescriptionFields" class="space-y-3">
                                <!-- Dynamic prescription fields will be added here -->
                                <p class="text-gray-500 text-sm italic" id="noPrescriptionMsg">No prescription entries. Click '+' to add.</p>
                            </div>
                        </div>

                        <!-- Appointment Logs Section -->
                        <div class="border p-4 rounded-md bg-white">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                                    <i class="fas fa-calendar-check text-purple-600"></i> <span>Appointment Logs</span>
                                </h3>
                                <button type="button" onclick="addAppointmentField()" class="bg-blue-200 text-blue-800 p-2 rounded-full hover:bg-blue-300 transition duration-200">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="appointmentFields" class="space-y-3">
                                <!-- Dynamic appointment fields will be added here -->
                                <p class="text-gray-500 text-sm italic" id="noAppointmentMsg">No appointment entries. Click '+' to add.</p>
                            </div>
                        </div>

                        <!-- Appointment Reminders Section (NEW) -->
                        <div class="border p-4 rounded-md bg-white">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                                    <i class="fas fa-bell text-orange-500"></i> <span>Appointment Reminders</span>
                                </h3>
                                <button type="button" onclick="addReminderField()" class="bg-blue-200 text-blue-800 p-2 rounded-full hover:bg-blue-300 transition duration-200">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="reminderFields" class="space-y-3">
                                <p class="text-gray-500 text-sm italic" id="noReminderMsg">No reminders. Click '+' to add.</p>
                            </div>
                        </div>

                        <div>
                            <label for="doctorNotes" class="block text-gray-700 font-medium mb-1 flex items-center space-x-2">
                                <i class="fas fa-notes-medical text-indigo-500"></i> <span>Doctor Notes (comma separated):</span>
                            </label>
                            <input type="text" id="doctorNotes" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200" placeholder="e.g., Follow up in 2 weeks">
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" id="submitBtn" class="w-full py-3 px-6 bg-gradient-to-r from-green-500 to-green-700 text-white font-semibold rounded-lg shadow-md hover:from-green-600 hover:to-green-800 transition duration-300 ease-in-out transform hover:scale-105">
                                Add Patient
                            </button>
                            <button type="button" id="cancelEditBtn" class="w-full py-3 px-6 bg-gradient-to-r from-gray-400 to-gray-600 text-white font-semibold rounded-lg shadow-md hover:from-gray-500 hover:to-gray-700 transition duration-300 ease-in-out transform hover:scale-105 hidden">
                                Cancel Edit
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Analytics Dashboard Section -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center space-x-2">
                        <i class="fas fa-chart-bar text-green-600"></i>
                        <span>Analytics Dashboard</span>
                    </h2>
                    <button onclick="fetchAnalytics()" class="w-full py-2 px-4 mb-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300 ease-in-out">
                        <i class="fas fa-sync-alt"></i> Refresh Analytics
                    </button>
                    <div id="analyticsContent" class="space-y-6">
                        <div id="loadingAnalytics" class="text-center py-4 hidden">
                            <div class="loader"></div>
                            <p class="text-gray-500">Loading analytics...</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center space-x-2"><i class="fas fa-notes-medical text-indigo-500"></i> Patients Per Condition</h3>
                            <ul id="conditionsList" class="list-disc list-inside text-gray-700">
                                <li class="text-gray-500 italic">No data yet. Click 'Refresh Analytics'.</li>
                            </ul>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center space-x-2"><i class="fas fa-pills text-yellow-600"></i> Most Prescribed Medications</h3>
                            <ul id="prescriptionsList" class="list-disc list-inside text-gray-700">
                                <li class="text-gray-500 italic">No data yet. Click 'Refresh Analytics'.</li>
                            </ul>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center space-x-2"><i class="fas fa-hospital-user text-red-500"></i> Average Age Per Department</h3>
                            <ul id="avgAgePerDepartmentList" class="list-disc list-inside text-gray-700">
                                <li class="text-gray-500 italic">No data yet. Click 'Refresh Analytics'.</li>
                            </ul>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center space-x-2"><i class="fas fa-calendar-alt text-blue-500"></i> Visits Per Month</h3>
                            <ul id="visitsPerMonthList" class="list-disc list-inside text-gray-700">
                                <li class="text-gray-500 italic">No data yet. Click 'Refresh Analytics'.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Search, Patient List -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center space-x-2">
                    <i class="fas fa-search-plus text-gray-600"></i>
                    <span>Search Patients</span>
                </h2>
                <div class="flex flex-col sm:flex-row gap-2 mb-4">
                    <input type="text" id="searchQuery" placeholder="Patient ID or Name" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-gray-400 focus:border-gray-400 transition duration-200">
                    <button onclick="searchPatients()" class="py-3 px-6 bg-gradient-to-r from-blue-500 to-blue-700 text-white font-semibold rounded-lg shadow-md hover:from-blue-600 hover:to-blue-800 transition duration-300 ease-in-out transform hover:scale-105 min-w-max">
                        Search
                    </button>
                </div>

                <!-- Advanced Filtering Options -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center space-x-2">
                        <i class="fas fa-filter text-gray-600"></i>
                        <span>Advanced Filters</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="minAgeFilter" class="block text-gray-700 text-sm font-medium mb-1">Min Age:</label>
                            <input type="number" id="minAgeFilter" placeholder="e.g., 18" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                        </div>
                        <div>
                            <label for="maxAgeFilter" class="block text-gray-700 text-sm font-medium mb-1">Max Age:</label>
                            <input type="number" id="maxAgeFilter" placeholder="e.g., 65" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                        </div>
                        <div>
                            <label for="genderFilter" class="block text-gray-700 text-sm font-medium mb-1">Gender:</label>
                            <select id="genderFilter" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                                <option value="">All Genders</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="departmentFilter" class="block text-gray-700 text-sm font-medium mb-1">Department:</label>
                            <input type="text" id="departmentFilter" placeholder="e.g., Cardiology" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-200">
                        </div>
                    </div>
                    <button onclick="resetFilters()" class="w-full mt-4 py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-300 ease-in-out">
                        <i class="fas fa-sync"></i> Reset Filters
                    </button>
                </div>

                <!-- Recently Viewed Patients Section (NEW) -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center space-x-2">
                        <i class="fas fa-eye text-indigo-500"></i>
                        <span>Recently Viewed Patients</span>
                    </h3>
                    <ul id="recentlyViewedList" class="list-disc list-inside text-gray-700 space-y-1">
                        <li class="text-gray-500 italic" id="noRecentlyViewedMsg">No recently viewed patients.</li>
                    </ul>
                </div>


                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center space-x-2">
                    <i class="fas fa-users text-gray-600"></i>
                    <span id="patientListTitle">Patient List</span>
                </h2>
                <!-- Removed 'View Deleted Patients' button -->

                <div id="loadingIndicator" class="text-center py-4 hidden">
                    <div class="loader"></div>
                    <p class="text-gray-500">Loading patients...</p>
                </div>
                <div id="patientList" class="space-y-4">
                    <!-- Patient cards will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button onclick="scrollToTop()" id="scrollToTopBtn" title="Go to top">↑ Top</button>

    <!-- Footer -->
    <footer class="w-full bg-blue-900 text-white text-center py-4 rounded-t-xl mt-8 shadow-inner">
        <p class="text-sm flex items-center space-x-2 justify-center">
            <i class="fas fa-copyright text-blue-300"></i> <span>2025 Healthcare PMS. All rights reserved.</span>
        </p>
        <p class="text-xs mt-1">
            <a href="#" class="hover:underline text-blue-300">Privacy Policy</a> |
            <a href="#" class="hover:underline text-blue-300">Terms of Service</a>
        </p>
    </footer>

    <script>
        // API Base URL
        const API_BASE_URL = 'http://localhost:8001/api'; // Corrected port to 8001

        // Authentication Elements 
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const authTitle = document.getElementById('authTitle');
        const authForm = document.getElementById('authForm');
        const authUsernameInput = document.getElementById('authUsername');
        const authPasswordInput = document.getElementById('authPassword');
        const roleSelectDiv = document.getElementById('roleSelectDiv');
        const authRoleSelect = document.getElementById('authRole');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
        const authMessageDiv = document.getElementById('authMessage');
        const logoutBtnNav = document.getElementById('logoutBtnNav'); // Logout button in nav bar

        let isLoginMode = true; // State for login/register form

        //  Patient Management Elements 
        const patientForm = document.getElementById('patientForm');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const patientIdInput = document.getElementById('patientId');
        const nameInput = document.getElementById('name');
        const ageInput = document.getElementById('age');
        const genderInput = document.getElementById('gender');
        const bloodGroupInput = document.getElementById('bloodGroup');
        const departmentInput = document.getElementById('department'); // Main form department input
        const contactInfoInput = document.getElementById('contactInfo');
        const allergiesInput = document.getElementById('allergies');
        const doctorNotesInput = document.getElementById('doctorNotes');
        const editingPatientIdInput = document.getElementById('editingPatientId');
        const patientListTitle = document.getElementById('patientListTitle');
        // const toggleListBtn = document.getElementById('toggleListBtn'); // Removed
        const loadingIndicator = document.getElementById('loadingIndicator');
        const patientListDiv = document.getElementById('patientList');
        const messageDiv = document.getElementById('message');

        // Structured data input containers
        const medicalHistoryFieldsContainer = document.getElementById('medicalHistoryFields');
        const prescriptionFieldsContainer = document.getElementById('prescriptionFields');
        const appointmentFieldsContainer = document.getElementById('appointmentFields');
        const reminderFieldsContainer = document.getElementById('reminderFields'); // NEW: Reminders container

        // Analytics display containers
        const loadingAnalytics = document.getElementById('loadingAnalytics');
        const conditionsList = document.getElementById('conditionsList');
        const prescriptionsList = document.getElementById('prescriptionsList');
        const avgAgePerDepartmentList = document.getElementById('avgAgePerDepartmentList');
        const visitsPerMonthList = document.getElementById('visitsPerMonthList');

        // Advanced filter elements
        const searchQueryInput = document.getElementById('searchQuery');
        const minAgeFilter = document.getElementById('minAgeFilter');
        const maxAgeFilter = document.getElementById('maxAgeFilter');
        const genderFilter = document.getElementById('genderFilter');
        const departmentFilter = document.getElementById('departmentFilter');

        // Recently Viewed Patients elements
        const recentlyViewedList = document.getElementById('recentlyViewedList');
        const noRecentlyViewedMsg = document.getElementById('noRecentlyViewedMsg');
        const RECENTLY_VIEWED_LIMIT = 5; // Limit for recently viewed patients

        // let showingDeletedPatients = false; // Removed

        // Utility Functions 
        function showMessage(type, text, targetDiv = messageDiv) {
            targetDiv.textContent = text;
            targetDiv.className = 'message';
            if (type === 'success') {
                targetDiv.classList.add('success');
            } else if (type === 'error') {
                targetDiv.classList.add('error');
            }
            targetDiv.classList.add('show');
            targetDiv.style.display = 'block';

            setTimeout(() => {
                targetDiv.classList.remove('show');
                setTimeout(() => {
                    targetDiv.style.display = 'none';
                }, 300);
            }, 3000);
        }

        function showLoading(show, target = 'patients') {
            if (target === 'patients') {
                if (show) {
                    loadingIndicator.classList.remove('hidden');
                    patientListDiv.innerHTML = '';
                } else {
                    loadingIndicator.classList.add('hidden');
                }
            } else if (target === 'analytics') {
                 if (show) {
                    loadingAnalytics.classList.remove('hidden');
                    conditionsList.innerHTML = '';
                    prescriptionsList.innerHTML = '';
                    avgAgePerDepartmentList.innerHTML = '';
                    visitsPerMonthList.innerHTML = '';
                } else {
                    loadingAnalytics.classList.add('hidden');
                }
            }
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('jwtToken');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        //  Authentication Logic 
        toggleAuthModeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                authTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                toggleAuthModeBtn.textContent = "Don't have an account? Register";
                roleSelectDiv.classList.add('hidden');
            } else {
                authTitle.textContent = 'Register';
                authSubmitBtn.textContent = 'Register';
                toggleAuthModeBtn.textContent = "Already have an account? Login";
                roleSelectDiv.classList.remove('hidden');
            }
            authForm.reset();
            authMessageDiv.style.display = 'none'; // Clear auth message on mode switch
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = authUsernameInput.value;
            const password = authPasswordInput.value;
            const role = authRoleSelect.value;

            const url = isLoginMode ? `${API_BASE_URL}/auth/login` : `${API_BASE_URL}/auth/register`;
            const payload = { username, password };
            if (!isLoginMode) {
                payload.role = role;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('jwtToken', data.token);
                    showMessage('success', data.message, authMessageDiv);
                    // Instead of directly showing the app, call checkAuth to handle the display
                    await checkAuth(); // Re-run checkAuth to transition properly
                } else {
                    showMessage('error', data.message || 'Authentication failed', authMessageDiv);
                }
            } catch (error) {
                console.error('Authentication error (network):', error);
                showMessage('error', `Network error: ${error.message}. Please ensure the backend server is running and accessible on ${API_BASE_URL}.`, authMessageDiv);
            } finally {
                // Any loading indicators for auth form would be hidden here
            }
        });

        const handleLogout = () => {
            localStorage.removeItem('jwtToken');
            appContainer.style.display = 'none';
            topNavBar.classList.add('hidden'); // Hide nav bar
            authContainer.style.display = 'block';
            authForm.reset();
            showMessage('success', 'Logged out successfully', authMessageDiv);
        };

        logoutBtnNav.addEventListener('click', handleLogout);

        // Check authentication status on page load
        async function checkAuth() {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                // Try to make an authenticated API call to validate the token
                try {
                    const response = await fetch(`${API_BASE_URL}/patients`, { // Using patients endpoint as a test
                        method: 'GET',
                        headers: getAuthHeaders(),
                    });

                    if (response.status === 401) {
                        // Token is invalid or expired, force logout
                        console.warn("Stored JWT token is invalid or expired. Logging out.");
                        handleLogout();
                    } else if (response.ok) {
                        // Token is valid, show app
                        authContainer.style.display = 'none';
                        appContainer.style.display = 'block';
                        topNavBar.classList.remove('hidden'); // Show nav bar
                        searchPatients(); // Load patients
                        fetchAnalytics(); // Load analytics
                        renderRecentlyViewed(); // Load recently viewed
                    } else {
                        // Other API errors (e.g., 500 server error), but not 401
                        console.error("API call failed during token validation:", response.status, await response.text());
                        showMessage('error', `Could not validate session. Please log in again. Status: ${response.status}`, authMessageDiv);
                        handleLogout(); // Log out on other API errors too to be safe
                    }
                } catch (error) {
                    // Network error during token validation (e.g., backend not running)
                    console.error('Network error during token validation:', error);
                    showMessage('error', `Network error validating session: ${error.message}. Please ensure the backend server is running and accessible on ${API_BASE_URL}.`, authMessageDiv);
                    handleLogout(); // Force logout if network fails
                }
            } else {
                // No token found, show login page
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
                topNavBar.classList.add('hidden'); // Ensure nav bar is hidden
            }
        }
        document.addEventListener('DOMContentLoaded', checkAuth);


        // Patient Management Logic 

        // Helper to clear dynamic fields
        function clearDynamicFields() {
            medicalHistoryFieldsContainer.innerHTML = '<p class="text-gray-500 text-sm italic" id="noMedicalHistoryMsg">No medical history entries. Click \'+ \' to add.</p>';
            prescriptionFieldsContainer.innerHTML = '<p class="text-gray-500 text-sm italic" id="noPrescriptionMsg">No prescription entries. Click \'+ \' to add.</p>';
            appointmentFieldsContainer.innerHTML = '<p class="text-gray-500 text-sm italic" id="noAppointmentMsg">No appointment entries. Click \'+ \' to add.</p>';
            reminderFieldsContainer.innerHTML = '<p class="text-gray-500 text-sm italic" id="noReminderMsg">No reminders. Click \'+\' to add.</p>'; // NEW: Clear reminders
        }

        // Reset form to "Add New Patient" mode
        function resetForm() {
            patientForm.reset();
            editingPatientIdInput.value = '';
            patientIdInput.readOnly = false;
            formTitle.innerHTML = '<i class="fas fa-user-plus text-blue-600"></i> <span>Add New Patient</span>';
            submitBtn.textContent = 'Add Patient';
            submitBtn.classList.remove('from-blue-500', 'to-blue-700');
            submitBtn.classList.add('from-green-500', 'to-green-700');
            cancelEditBtn.classList.add('hidden');
            clearDynamicFields(); // Clear dynamic fields on reset
        }

        // Functions to add dynamic input fields
        function addMedicalHistoryField(condition = '', diagnosisDate = '', notes = '') {
            document.getElementById('noMedicalHistoryMsg')?.remove(); // Remove placeholder message
            const div = document.createElement('div');
            div.className = 'medical-history-entry border border-gray-200 p-3 rounded-md bg-gray-50 space-y-2 relative';
            div.innerHTML = `
                <button type="button" onclick="this.closest('.medical-history-entry').remove(); updateEmptyMessage('medicalHistoryFields', 'noMedicalHistoryMsg', 'No medical history entries. Click \'+ \' to add.')" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>
                <label class="block text-gray-700 text-sm font-medium">Condition:</label>
                <input type="text" value="${condition}" placeholder="e.g., Hypertension" class="w-full p-2 border border-gray-300 rounded-md text-sm medical-history-condition">
                <label class="block text-gray-700 text-sm font-medium">Diagnosis Date:</label>
                <input type="date" value="${diagnosisDate ? diagnosisDate.split('T')[0] : ''}" class="w-full p-2 border border-gray-300 rounded-md text-sm medical-history-date">
                <label class="block text-gray-700 text-sm font-medium">Notes:</label>
                <textarea placeholder="e.g., Managed with medication" class="w-full p-2 border border-gray-300 rounded-md text-sm medical-history-notes">${notes}</textarea>
            `;
            medicalHistoryFieldsContainer.appendChild(div);
        }

        function addPrescriptionField(medication = '', dosage = '', startDate = '', endDate = '') {
            document.getElementById('noPrescriptionMsg')?.remove();
            const div = document.createElement('div');
            div.className = 'prescription-entry border border-gray-200 p-3 rounded-md bg-gray-50 space-y-2 relative';
            div.innerHTML = `
                <button type="button" onclick="this.closest('.prescription-entry').remove(); updateEmptyMessage('prescriptionFields', 'noPrescriptionMsg', 'No prescription entries. Click \'+ \' to add.')" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>
                <label class="block text-gray-700 text-sm font-medium">Medication:</label>
                <input type="text" value="${medication}" placeholder="e.g., Lisinopril" class="w-full p-2 border border-gray-300 rounded-md text-sm prescription-medication">
                <label class="block text-gray-700 text-sm font-medium">Dosage:</label>
                <input type="text" value="${dosage}" placeholder="e.g., 10mg daily" class="w-full p-2 border border-gray-300 rounded-md text-sm prescription-dosage">
                <label class="block text-gray-700 text-sm font-medium">Start Date:</label>
                <input type="date" value="${startDate ? startDate.split('T')[0] : ''}" class="w-full p-2 border border-gray-300 rounded-md text-sm prescription-startDate">
                <label class="block text-gray-700 text-sm font-medium">End Date (Optional):</label>
                <input type="date" value="${endDate ? endDate.split('T')[0] : ''}" class="w-full p-2 border border-gray-300 rounded-md text-sm prescription-endDate">
            `;
            prescriptionFieldsContainer.appendChild(div);
        }

        function addAppointmentField(date = '', reason = '', doctor = '') {
            document.getElementById('noAppointmentMsg')?.remove();
            const div = document.createElement('div');
            div.className = 'appointment-entry border border-gray-200 p-3 rounded-md bg-gray-50 space-y-2 relative';
            div.innerHTML = `
                <button type="button" onclick="this.closest('.appointment-entry').remove(); updateEmptyMessage('appointmentFields', 'noAppointmentMsg', 'No appointment entries. Click \'+ \' to add.')" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>
                <label class="block text-gray-700 text-sm font-medium">Date:</label>
                <input type="date" value="${date ? date.split('T')[0] : ''}" required class="w-full p-2 border border-gray-300 rounded-md text-sm appointment-date">
                <label class="block text-gray-700 text-sm font-medium">Reason:</label>
                <input type="text" value="${reason}" placeholder="e.g., Follow-up" class="w-full p-2 border border-gray-300 rounded-md text-sm appointment-reason">
                <label class="block text-gray-700 text-sm font-medium">Doctor:</label>
                <input type="text" value="${doctor}" placeholder="e.g., Dr. Smith" class="w-full p-2 border border-gray-300 rounded-md text-sm appointment-doctor">
            `;
            appointmentFieldsContainer.appendChild(div);
        }

        // NEW: Function to add a reminder field
        function addReminderField(reminderDate = '', reminderNotes = '') {
            document.getElementById('noReminderMsg')?.remove();
            const div = document.createElement('div');
            div.className = 'reminder-entry border border-gray-200 p-3 rounded-md bg-gray-50 space-y-2 relative';
            div.innerHTML = `
                <button type="button" onclick="this.closest('.reminder-entry').remove(); updateEmptyMessage('reminderFields', 'noReminderMsg', 'No reminders. Click \'+ \' to add.')" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>
                <label class="block text-gray-700 text-sm font-medium">Reminder Date:</label>
                <input type="date" value="${reminderDate ? reminderDate.split('T')[0] : ''}" required class="w-full p-2 border border-gray-300 rounded-md text-sm reminder-date">
                <label class="block text-gray-700 text-sm font-medium">Notes:</label>
                <textarea placeholder="e.g., Call for annual check-up" class="w-full p-2 border border-gray-300 rounded-md text-sm reminder-notes">${reminderNotes}</textarea>
            `;
            reminderFieldsContainer.appendChild(div);
        }


        // Helper to update empty message if all dynamic fields are removed
        function updateEmptyMessage(containerId, messageId, messageText) {
            const container = document.getElementById(containerId);
            if (container.children.length === 0) {
                const p = document.createElement('p');
                p.className = 'text-gray-500 text-sm italic';
                p.id = messageId;
                p.textContent = messageText;
                container.appendChild(p);
            }
        }


        // Form submission handler (handles both add and update)
        patientForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Collect Medical History
            const medicalHistory = Array.from(medicalHistoryFieldsContainer.children)
                .filter(el => el.classList.contains('medical-history-entry'))
                .map(entry => ({
                    condition: entry.querySelector('.medical-history-condition').value,
                    diagnosisDate: entry.querySelector('.medical-history-date').value ? new Date(entry.querySelector('.medical-history-date').value).toISOString().split('T')[0] : undefined, // Format as ISO-MM-DD
                    notes: entry.querySelector('.medical-history-notes').value
                })).filter(entry => entry.condition || entry.notes); // Only include if condition or notes present

            // Collect Prescriptions
            const currentPrescriptions = Array.from(prescriptionFieldsContainer.children)
                .filter(el => el.classList.contains('prescription-entry'))
                .map(entry => ({
                    medication: entry.querySelector('.prescription-medication').value,
                    dosage: entry.querySelector('.prescription-dosage').value,
                    startDate: entry.querySelector('.prescription-startDate').value ? new Date(entry.querySelector('.prescription-startDate').value).toISOString().split('T')[0] : undefined,
                    endDate: entry.querySelector('.prescription-endDate').value ? new Date(entry.querySelector('.prescription-endDate').value).toISOString().split('T')[0] : undefined,
                })).filter(entry => entry.medication || entry.dosage);

            // Collect Appointment Logs
            const appointmentLogs = Array.from(appointmentFieldsContainer.children)
                .filter(el => el.classList.contains('appointment-entry'))
                .map(entry => ({
                    date: entry.querySelector('.appointment-date').value ? new Date(entry.querySelector('.appointment-date').value).toISOString().split('T')[0] : undefined,
                    reason: entry.querySelector('.appointment-reason').value,
                    doctor: entry.querySelector('.appointment-doctor').value
                })).filter(entry => entry.reason || entry.doctor);

            // NEW: Collect Appointment Reminders
            const appointmentReminders = Array.from(reminderFieldsContainer.children)
                .filter(el => el.classList.contains('reminder-entry'))
                .map(entry => ({
                    reminderDate: entry.querySelector('.reminder-date').value ? new Date(entry.querySelector('.reminder-date').value).toISOString().split('T')[0] : undefined,
                    reminderNotes: entry.querySelector('.reminder-notes').value
                })).filter(entry => entry.reminderDate || entry.reminderNotes);


            const patientData = {
                patientId: patientIdInput.value,
                name: nameInput.value,
                age: parseInt(ageInput.value),
                gender: genderInput.value,
                bloodGroup: bloodGroupInput.value,
                department: departmentInput.value, 
                contactInfo: contactInfoInput.value,
                allergies: allergiesInput.value.split(',').map(s => s.trim()).filter(s => s),
                medicalHistory: medicalHistory, 
                currentPrescriptions: currentPrescriptions, 
                doctorNotes: doctorNotesInput.value.split(',').map(s => s.trim()).filter(s => s),
                appointmentLogs: appointmentLogs, 
                appointmentReminders: appointmentReminders, 
            };

            const isEditing = editingPatientIdInput.value !== '';
            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `${API_BASE_URL}/patients/${editingPatientIdInput.value}` : `${API_BASE_URL}/patients`;

            showLoading(true);
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(patientData),
                });
                const data = await response.json();
                if (response.status === 401) { handleLogout(); return; } 
                if (response.ok) {
                    showMessage('success', isEditing ? 'Patient updated successfully!' : 'Patient added successfully!');
                    resetForm();
                    searchPatients(); // Always refresh active list after add/update
                    fetchAnalytics(); // Refresh analytics after patient data changes
                } else {
                    showMessage('error', data.message || `Failed to ${isEditing ? 'update' : 'add'} patient. Status: ${response.status}`);
                }
            } catch (error) {
                console.error(`Error during ${isEditing ? 'update' : 'add'} patient (network):`, error);
                showMessage('error', `Network error during ${isEditing ? 'update' : 'add'} operation: ${error.message}. Please ensure the backend server is running and accessible on ${API_BASE_URL}.`);
            } finally {
                showLoading(false);
            }
        });

        // Cancel Edit button handler
        cancelEditBtn.addEventListener('click', resetForm);

        // Function to display patients (only active patients now)
        function displayPatients(patients) { // isDeletedList parameter removed
            patientListDiv.innerHTML = ''; 

            if (patients.length === 0) {
                patientListDiv.innerHTML = `<p class="text-gray-500 italic">No patients found.</p>`; 
                return;
            }

            patients.forEach((patient, index) => {
                const patientCard = document.createElement('div');
                patientCard.className = 'patient-card bg-white p-4 rounded-lg shadow-md flex flex-col justify-between transition-all duration-300 ease-in-out hover:shadow-lg hover:scale-[1.01] animate-slideInUp';
                patientCard.style.animationDelay = `${index * 0.05}s`;

                // Format structured data for display
                const medicalHistoryDisplay = patient.medicalHistory && patient.medicalHistory.length > 0
                    ? patient.medicalHistory.map(mh => {
                        const datePart = mh.diagnosisDate ? ` (${new Date(mh.diagnosisDate).toLocaleDateString()})` : '';
                        return `${mh.condition}${datePart}`;
                    }).join('; ')
                    : 'None';
                const prescriptionsDisplay = patient.currentPrescriptions && patient.currentPrescriptions.length > 0
                    ? patient.currentPrescriptions.map(p => `${p.medication} (${p.dosage})`).join('; ')
                    : 'None';
                const appointmentsDisplay = patient.appointmentLogs && patient.appointmentLogs.length > 0
                    ? patient.appointmentLogs.map(a => {
                        const datePart = a.date ? `${new Date(a.date).toLocaleDateString()} - ` : '';
                        return `${datePart}${a.reason} (${a.doctor})`;
                    }).join('; ')
                    : 'None';
                const remindersDisplay = patient.appointmentReminders && patient.appointmentReminders.length > 0
                    ? patient.appointmentReminders.map(r => {
                        const datePart = r.reminderDate ? `${new Date(r.reminderDate).toLocaleDateString()} - ` : '';
                        return `${datePart}${r.reminderNotes}`;
                    }).join('; ')
                    : 'None';

                // Action buttons now only include Edit and Permanent Delete
                const actionButtonsHTML = `
                    <button onclick="editPatient('${patient.patientId}')" class="py-1 px-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 shadow-sm text-sm flex items-center space-x-1">
                        <i class="fas fa-edit"></i> <span class="hidden sm:inline">Edit</span>
                    </button>
                    <button class="delete-btn py-1 px-3 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200 shadow-sm text-sm flex items-center space-x-1" onclick="deletePatient('${patient.patientId}')">
                        <i class="fas fa-trash-alt"></i> <span class="hidden sm:inline">Delete</span>
                    </button>
                `;

                // Redesigned patient card structure
                patientCard.innerHTML = `
                    <div class="flex items-center space-x-3 mb-2 border-b pb-2 border-gray-200">
                        <img src="https://placehold.co/50x50/d1e2f3/3f51b5?text=P" alt="Patient Avatar" class="rounded-full shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/50x50/d1e2f3/3f51b5?text=Err';">
                        <p class="font-bold text-lg text-blue-700">ID: <span class="font-normal text-gray-800" id="patientIdDisplay-${patient.patientId}">${patient.patientId}</span></p>
                        <button onclick="copyToClipboard('${patient.patientId}')" class="ml-auto py-1 px-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200 shadow-sm text-xs flex items-center space-x-1">
                            <i class="fas fa-copy"></i> <span class="hidden sm:inline">Copy ID</span>
                        </button>
                    </div>
                    <div class="flex-grow space-y-1 text-sm text-gray-700">
                        <p>Name: <span class="font-medium">${patient.name}</span></p>
                        <p>Age: ${patient.age}, Gender: ${patient.gender}</p>
                        <p>Blood Group: ${patient.bloodGroup || 'N/A'}</p>
                        <p>Department: ${patient.department || 'N/A'}</p>
                        <p>Contact: ${patient.contactInfo || 'N/A'}</p>
                        <p>Allergies: ${patient.allergies && patient.allergies.length > 0 ? patient.allergies.join(', ') : 'None'}</p>
                        <p>Medical History: <span class="font-normal text-gray-800">${medicalHistoryDisplay}</span></p>
                        <p>Prescriptions: <span class="font-normal text-gray-800">${prescriptionsDisplay}</span></p>
                        <p>Appointments: <span class="font-normal text-gray-800">${appointmentsDisplay}</span></p>
                        <p>Reminders: <span class="font-normal text-gray-800">${remindersDisplay}</span></p>
                        <p>Doctor Notes: ${patient.doctorNotes && patient.doctorNotes.length > 0 ? patient.doctorNotes.join(', ') : 'None'}</p>
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        ${actionButtonsHTML}
                    </div>
                `;
                patientListDiv.appendChild(patientCard);
            });
        }

        async function searchPatients() {
            showLoading(true, 'patients');
            const searchQuery = document.getElementById('searchQuery').value.trim();
            const minAge = minAgeFilter.value.trim();
            const maxAge = maxAgeFilter.value.trim();
            const gender = genderFilter.value;
            const department = departmentFilter.value.trim();

            let url = new URL(`${API_BASE_URL}/patients`);
            let params = new URLSearchParams();

            if (searchQuery) {
                if (/^[a-zA-Z]+\d+$/.test(searchQuery) || /^\d+$/.test(searchQuery)) {
                    params.append('patientId', searchQuery);
                } else {
                    params.append('search', searchQuery);
                }
            } else {
                if (minAge) params.append('minAge', minAge);
                if (maxAge) params.append('maxAge', maxAge);
                if (gender) params.append('gender', gender);
                if (department) params.append('department', department);
            }

            url.search = params.toString();

            try {
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: getAuthHeaders(),
                });
                if (response.status === 401) { handleLogout(); return; }
                const patients = await response.json();
                if (response.ok) {
                    displayPatients(patients); // No 'isDeletedList' parameter needed
                } else {
                    showMessage('error', patients.message || `Error searching patients. Status: ${response.status}.`);
                    displayPatients([]);
                }
            } catch (error) {
                console.error('Error searching patients (network):', error);
                showMessage('error', `Network error during search operation: ${error.message}. Please ensure the backend server is running and accessible on ${API_BASE_URL}.`);
                displayPatients([]);
            } finally {
                showLoading(false, 'patients');
            }
        }

        function resetFilters() {
            searchQueryInput.value = '';
            minAgeFilter.value = '';
            maxAgeFilter.value = '';
            genderFilter.value = '';
            departmentFilter.value = '';
            searchPatients(); 
            showMessage('success', 'Filters reset successfully!');
        }

        // Removed viewDeletedPatients and togglePatientLists functions

        async function deletePatient(patientId) {
            // Updated modal message for permanent delete
            const modalConfirmed = await showConfirmModal(`WARNING: Permanently delete patient with ID: ${patientId}?`, 'This action CANNOT be undone and will remove the record from the database entirely.', 'Confirm Permanent Delete', 'Cancel', 'red-dark');
            if (!modalConfirmed) { return; }

            showLoading(true, 'patients');
            try {
                const response = await fetch(`${API_BASE_URL}/patients/${patientId}`, { // Direct DELETE endpoint
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                });
                if (response.status === 401) { handleLogout(); return; }
                const data = await response.json();
                if (response.ok) {
                    showMessage('success', data.message);
                    searchPatients(); // Refresh patient list after deletion
                } else {
                    showMessage('error', data.message || `Failed to permanently delete patient. Status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error permanently deleting patient (network):', error);
                showMessage('error', `Network error during permanent deletion: ${error.message}. Please ensure the backend server is running and accessible on ${API_BASE_URL}.`);
            } finally {
                showLoading(false, 'patients');
            }
        }

        // Removed restorePatient function

        // Custom Confirmation Modal Function (unchanged)
        function showConfirmModal(title, message, confirmText, cancelText, type = 'default') {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
                        <p class="text-lg font-semibold mb-4">${title}</p>
                        <p class="text-gray-600 mb-6 ${type === 'red-dark' ? 'text-red-600 font-bold' : ''}">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirmBtn" class="py-2 px-5 ${type === 'red' ? 'bg-red-500 hover:bg-red-600' : type === 'green' ? 'bg-green-600 hover:bg-green-700' : type === 'red-dark' ? 'bg-red-800 hover:bg-red-900' : 'bg-blue-500 hover:bg-blue-600'} text-white font-medium rounded-md transition duration-200 shadow">
                                ${confirmText}
                            </button>
                            <button id="cancelBtn" class="py-2 px-5 bg-gray-300 text-gray-800 font-medium rounded-md hover:bg-gray-400 transition duration-200 shadow">
                                ${cancelText}
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirmBtn').onclick = () => { document.body.removeChild(modal); resolve(true); };
                document.getElementById('cancelBtn').onclick = () => { document.body.removeChild(modal); resolve(false); };
            });
        }

        async function editPatient(patientId) {
            // No need to toggle lists, always operating on the main list
            showLoading(true, 'patients');
            try {
                const response = await fetch(`${API_BASE_URL}/patients/${patientId}`, {
                    method: 'GET',
                    headers: getAuthHeaders(),
                });
                if (response.status === 401) { handleLogout(); return; }
                const patient = await response.json();

                if (!response.ok) {
                    showMessage('error', patient.message || 'Failed to fetch patient data for editing.');
                    return;
                }

                // Populate basic fields
                editingPatientIdInput.value = patient.patientId;
                patientIdInput.value = patient.patientId;
                patientIdInput.readOnly = true;
                nameInput.value = patient.name;
                ageInput.value = patient.age;
                document.getElementById('gender').value = patient.gender;
                bloodGroupInput.value = patient.bloodGroup || '';
                departmentInput.value = patient.department || ''; 
                contactInfoInput.value = patient.contactInfo || '';
                allergiesInput.value = patient.allergies ? patient.allergies.join(', ') : '';
                doctorNotesInput.value = patient.doctorNotes ? patient.doctorNotes.join(', ') : '';

                // Populate structured fields
                clearDynamicFields(); 
                if (patient.medicalHistory && patient.medicalHistory.length > 0) {
                    patient.medicalHistory.forEach(mh => addMedicalHistoryField(mh.condition, mh.diagnosisDate, mh.notes));
                } else {
                     document.getElementById('noMedicalHistoryMsg').style.display = 'block';
                }
                if (patient.currentPrescriptions && patient.currentPrescriptions.length > 0) {
                    patient.currentPrescriptions.forEach(p => addPrescriptionField(p.medication, p.dosage, p.startDate, p.endDate));
                } else {
                     document.getElementById('noPrescriptionMsg').style.display = 'block';
                }
                if (patient.appointmentLogs && patient.appointmentLogs.length > 0) {
                    patient.appointmentLogs.forEach(a => addAppointmentField(a.date, a.reason, a.doctor));
                } else {
                     document.getElementById('noAppointmentMsg').style.display = 'block';
                }
                // Populate reminder fields
                if (patient.appointmentReminders && patient.appointmentReminders.length > 0) {
                    patient.appointmentReminders.forEach(r => addReminderField(r.reminderDate, r.reminderNotes));
                } else {
                     document.getElementById('noReminderMsg').style.display = 'block';
                }


                formTitle.innerHTML = '<i class="fas fa-user-edit text-blue-600"></i> <span>Edit Patient</span>';
                submitBtn.textContent = 'Update Patient';
                submitBtn.classList.remove('from-green-500', 'to-green-700');
                submitBtn.classList.add('from-blue-500', 'to-blue-700');
                cancelEditBtn.classList.remove('hidden');

                showMessage('success', `Editing patient: ${patient.name}`);
                scrollToTop();

                // Add to recently viewed
                saveRecentlyViewed({ patientId: patient.patientId, name: patient.name });

            } catch (error) {
                console.error('Error fetching patient for edit (network):', error);
                showMessage('error', `Network error fetching patient for edit: ${error.message}. Please ensure the backend server is running and accessible on ${API_BASE_URL}.`);
            } finally {
                showLoading(false, 'patients');
            }
        }


        // Analytics Dashboard Logic (unchanged logic, as it operates on all non-deleted patients anyway)

        async function fetchAnalytics() {
            showLoading(true, 'analytics');
            try {
                // Fetch Conditions
                const conditionsResponse = await fetch(`${API_BASE_URL}/analytics/conditions`, { headers: getAuthHeaders() });
                if (conditionsResponse.status === 401) { handleLogout(); return; }
                const conditionsData = await conditionsResponse.json();
                displayAnalyticsData(conditionsList, conditionsData, (item) => `${item._id}: ${item.count} patients`, 'conditions');

                // Fetch Prescriptions
                const prescriptionsResponse = await fetch(`${API_BASE_URL}/analytics/prescriptions`, { headers: getAuthHeaders() });
                if (prescriptionsResponse.status === 401) { handleLogout(); return; }
                const prescriptionsData = await prescriptionsResponse.json();
                displayAnalyticsData(prescriptionsList, prescriptionsData, (item) => `${item._id}: ${item.count} prescriptions`, 'prescriptions');

                // Fetch Average Age per Department
                const avgAgeResponse = await fetch(`${API_BASE_URL}/analytics/avg-age-per-department`, { headers: getAuthHeaders() });
                if (avgAgeResponse.status === 401) { handleLogout(); return; }
                const avgAgeData = await avgAgeResponse.json();
                displayAnalyticsData(avgAgePerDepartmentList, avgAgeData, (item) => `${item._id || 'N/A'}: ${item.averageAge.toFixed(1)} years (from ${item.count} patients)`, 'avgAge');

                // Fetch Visits Per Month
                const visitsResponse = await fetch(`${API_BASE_URL}/analytics/visits-per-month`, { headers: getAuthHeaders() });
                if (visitsResponse.status === 401) { handleLogout(); return; }
                const visitsData = await visitsResponse.json();
                displayAnalyticsData(visitsPerMonthList, visitsData, (item) => {
                    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    return `${monthNames[item._id.month - 1]}/${item._id.year}: ${item.count} visits`;
                }, 'visits');

            } catch (error) {
                console.error('Error fetching analytics (network):', error);
                showMessage('error', `Network error fetching analytics: ${error.message}. Please ensure the backend server is running and accessible on ${API_BASE_URL}.`);
                // Clear lists and show generic message if error
                displayAnalyticsData(conditionsList, [], null, 'conditions');
                displayAnalyticsData(prescriptionsList, [], [], 'prescriptions');
                displayAnalyticsData(avgAgePerDepartmentList, [], null, 'avgAge');
                displayAnalyticsData(visitsPerMonthList, [], null, 'visits');
            } finally {
                showLoading(false, 'analytics');
            }
        }

        function displayAnalyticsData(container, data, formatter, dataType) {
            container.innerHTML = ''; // Clear previous data
            if (data.length === 0) {
                let message;
                switch(dataType) {
                    case 'conditions': message = 'No condition data found.'; break;
                    case 'prescriptions': message = 'No prescription data found.'; break;
                    case 'avgAge': message = 'No department data found for average age.'; break;
                    case 'visits': message = 'No appointment data found for visits.'; break;
                    default: message = 'No data available.';
                }
                const li = document.createElement('li');
                li.className = 'text-gray-500 italic';
                li.textContent = message;
                container.appendChild(li);
                return;
            }
            data.forEach(item => {
                const li = document.createElement('li');
                li.textContent = formatter(item);
                li.className = 'py-1 border-b border-gray-100 last:border-b-0';
                container.appendChild(li);
            });
        }

        //  Recently Viewed Patients Logic (unchanged) 
        function saveRecentlyViewed(patient) {
            let recentlyViewed = loadRecentlyViewed();
            // Remove if already exists to move it to the top
            recentlyViewed = recentlyViewed.filter(p => p.patientId !== patient.patientId);
            // Add to the beginning
            recentlyViewed.unshift(patient);
            // Trim to limit
            recentlyViewed = recentlyViewed.slice(0, RECENTLY_VIEWED_LIMIT);
            localStorage.setItem('recentlyViewedPatients', JSON.stringify(recentlyViewed));
            renderRecentlyViewed();
        }

        function loadRecentlyViewed() {
            try {
                const data = localStorage.getItem('recentlyViewedPatients');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error parsing recently viewed patients from localStorage:", e);
                return [];
            }
        }

        function renderRecentlyViewed() {
            const patients = loadRecentlyViewed();
            recentlyViewedList.innerHTML = '';
            if (patients.length === 0) {
                noRecentlyViewedMsg.style.display = 'block';
                recentlyViewedList.appendChild(noRecentlyViewedMsg);
            } else {
                noRecentlyViewedMsg.style.display = 'none';
                patients.forEach(patient => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700 py-1 cursor-pointer hover:text-blue-600 hover:underline transition duration-150 ease-in-out';
                    li.innerHTML = `<span class="font-medium">${patient.name}</span> (ID: ${patient.patientId})`;
                    li.onclick = () => editPatient(patient.patientId); // Allow clicking to view/edit
                    recentlyViewedList.appendChild(li);
                });
            }
        }


        // Copy to Clipboard Function (unchanged) 
        function copyToClipboard(text) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showMessage('success', `Patient ID '${text}' copied to clipboard!`);
        }


        //  Scroll to Top Functionality (unchanged) 
        const scrollToTopBtn = document.getElementById("scrollToTopBtn");

        window.onscroll = function() { scrollFunction() };
        function scrollFunction() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollToTopBtn.style.display = "block";
            } else {
                scrollToTopBtn.style.display = "none";
            }
        }
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
